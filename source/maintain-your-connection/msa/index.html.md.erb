---
title: Matching Service Adapter
weight: 20
---

# Matching Service Adapter

These instructions apply to you if you're using the legacy setup with a Matching Service Adapter (MSA).

<%= partial "partials/get-self-signed-certificates" %>

## Update the encryption key and certificate

### Step 1. Add the new encryption key pair to your MSA configuration

Add a second list item containing the details for your new key and self-signed certificate under `encryptionKeys` in your [MSA configuration][msa-config], for example:

    ```yaml
    encryptionKeys:
    - publicKey:
        certFile: msa_encryption_2016.crt
        name: MSA Encryption 2016
      privateKey:
        keyFile: msa_encryption_2016.pk8
    - publicKey:
        certFile: msa_encryption_2017.crt
        name: MSA Encryption 2017
      privateKey:
        keyFile: msa_encryption_2017.pk8
    ```

Restart the MSA to implement the configuration changes. The MSA can now use both the new and old keys to decrypt SAML messages.

### Step 2. Upload the new encryption certificate

Upload your new encryption certificate to the GOV.UK Verify Service Admin tool.

You will receive e-mail confirmation that the GOV.UK Verify team have deployed your encryption certificate.

### Step 3. Delete the old encryption key pair

Delete the old encryption key and certificate.

Restart the MSA to implement the configuration changes.

The MSA now uses the new encryption key to decrypt SAML messages, and the GOV.UK Verify hub now uses your new self-signed encryption certificate to encrypt SAML messages for your service.

> While both old and new keys are in use, you may see error messages in the logs with the description `Unwrapping failed`. These messages appear because the MSA attempts to decrypt the SAML message using each key in turn. You can safely ignore these messages. However, do not ignore any other error messages related to SAML decryption.

## Update the signing keys and certificate

### Step 1. Upload the new signing certificate

Upload your new signing certificate to the GOV.UK Verify Service Admin tool.

You will get an e-mail confirmation when the GOV.UK Verify team have deployed your new signing certificate. In the meantime, you can move on to adding the new signing key and certificate to your MSA configuration.

### Step 2. Add the new signing key pair to your MSA configuration

Add your new signing key and self-signed certificate to `signingKeys.secondary` in your MSA configuration, for example:

```yaml
signingKeys:
  primary:
    publicKey:
      certFile: msa_signing_2016.crt
      name: 2016 MSA Signing Key
    privateKey:
      keyFile: msa_signing_2016.pk8
  secondary:
    publicKey:
      certFile: msa_signing_2017.crt
      name: 2017 MSA Signing Key
    privateKey:
      keyFile: msa_signing_2017.pk8
```

Restart the MSA to publish the new signing certificate to its metadata. You must do this because the MSA publishes its certificates containing the public keys in its own metadata at run time. The service provider you’re using reads this metadata and uses the MSA's signing certificate to trust assertions signed by the MSA.

If you’re using the VSP, wait for it to load the MSA metadata. The VSP periodically refreshes its metadata and will log when it has finished. Once it loads the new metadata, the VSP trusts assertions signed with the new MSA signing key.

### Step 3. Delete the old signing key pair

Wait for e-mail confirmation that the GOV.UK Verify team have deployed your new signing certificate before.

Delete the `signingKeys.primary` section and rename `signingKeys.secondary` to `signingKeys.primary`. The MSA now signs the assertions with the new  key.

Restart the MSA to update its metadata to contain only the new signing certificate.

Your service provider now trusts assertions signed with your new MSA signing key.

<%= partial "partials/links" %>
