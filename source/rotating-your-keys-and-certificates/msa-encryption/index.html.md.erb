---
title: Matching Service Adapter encryption
weight: 25
---

# Matching Service Adapter encryption

If your connection to GOV.UK Verify involves a Matching Service Adapter (MSA), you are responsible for keeping its encryption and signing certificates up to date.

You must update the certificates containing your MSA's public keys before they expire. If you don't, your users wont be able to access your service using GOV.UK Verify.

## Rotate your MSA encryption key and certificate

### Step 1. Create a new self-signed encryption certificate

<%= partial("partials/get-self-signed-certificates") %>

### Step 2. Add the new encryption key and certificate to your MSA configuration

Add a second list item containing the details for your new key and self-signed certificate under `encryptionKeys` in your [MSA configuration][msa-config], for example:

```yaml
encryptionKeys:
- publicKey:
    certFile: msa_encryption_2016.crt
    name: MSA Encryption 2016
  privateKey:
    keyFile: msa_encryption_2016.pk8
- publicKey:
    certFile: msa_encryption_2017.crt
    name: MSA Encryption 2017
  privateKey:
    keyFile: msa_encryption_2017.pk8
```

| Field name | Description                                                                                       |
| ---------- | ------------------------------------------------------------------------------------------------- |
| `certFile` | The name of the `.crt` file containing your certificate                                                |
| `name`     | A meaningful name for your certificate which is published in your MSA's metadata |
| `keyFile`  |  The name of the `.pk8` file containing your private key                                                                                                |

Restart the MSA to implement the configuration changes. The MSA can now use both the new and old keys to decrypt SAML messages.

### Step 3. Upload the new encryption certificate

Upload your new encryption certificate to the GOV.UK Verify Manage certificates service.

This starts a deployment process to replace your old MSA encryption certificate with the new one in the GOV.UK Verify Hub configuration.
When the deployment is complete, the GOV.UK Verify Hub will be using your new certificate to encrypt messages for your service.

The deployment process takes approximately 1 hour. You will receive e-mail confirmation when the GOV.UK Verify Hub starts using your new encryption certificate. You can also check the deployment status on the [GOV.UK Verify Manage certificates service dashboard][dashboard].

Wait for deployment confirmation before moving to the next step.

### Step 4. Delete the old encryption key and certificate

Delete the old encryption key and certificate.

Restart the MSA to implement the configuration changes.

The MSA now uses the new encryption key to decrypt SAML messages, and the GOV.UK Verify hub now uses your new self-signed encryption certificate to encrypt SAML messages for your service.

> While both old and new keys are in use, you may see error messages in the logs with the description `Unwrapping failed`. These messages appear because the MSA attempts to decrypt the SAML message using each key in turn. You can safely ignore these messages. However, do not ignore any other error messages related to SAML decryption.

<%= partial "partials/links" %>
